From 8096f82b8211e2d75f57048a30961e1d8616364e Mon Sep 17 00:00:00 2001
From: vincent <vbusoenseirb@gmail.com>
Date: Sat, 26 Oct 2019 10:44:34 +0200
Subject: [PATCH] fbtft set to 39Hz refresh rate

---
 drivers/staging/fbtft/fb_st7789v.c | 16 +++++++++++++---
 drivers/staging/fbtft/fbtft-core.c |  8 +++++++-
 2 files changed, 20 insertions(+), 4 deletions(-)
 mode change 100644 => 100755 drivers/staging/fbtft/fb_st7789v.c
 mode change 100644 => 100755 drivers/staging/fbtft/fbtft-core.c

diff --git a/drivers/staging/fbtft/fb_st7789v.c b/drivers/staging/fbtft/fb_st7789v.c
old mode 100644
new mode 100755
index 69f52af..00756de
--- a/drivers/staging/fbtft/fb_st7789v.c
+++ b/drivers/staging/fbtft/fb_st7789v.c
@@ -150,12 +150,12 @@ static int init_display(struct fbtft_par *par)
 	 */
 	write_reg(par, PWCTRL1, 0xA4, 0xA1);
 
-	/* Ystart at 80 , Yend at 240 */
-	write_reg(par, 0x2B, 0x00, 0x50, 0x00, 0xF0);
-
 	/* Display Inversion of colors */
 	write_reg(par, 0x21);
 
+	/* 39Hz refresh rate */
+	write_reg(par, 0xC6,0x1F);
+
 	write_reg(par, MIPI_DCS_SET_DISPLAY_ON);
 
 	return 0;
@@ -190,6 +190,16 @@ static int set_var(struct fbtft_par *par)
 		return -EINVAL;
 	}
 	write_reg(par, MIPI_DCS_SET_ADDRESS_MODE, madctl_par);
+
+	// All offset operations are done after in fbtft_set_addr_win, not here
+	/* Ystart at 0 , Yend at 239 */
+	//write_reg(par, 0x2B, 0x00, 0x50, 0x00, 0xEF);
+	write_reg(par, 0x2B, 0x00, 0x00, 0x00, 0xEF);
+	//write_reg(par, 0x2B, 0x00, 0x50, 0x01, 0x3F);
+	/* Xstart at 80 , Xend at 319 */
+	write_reg(par, 0x2A, 0x00, 0x50, 0x01, 0x3F);
+	//write_reg(par, 0x2A, 0x00, 0x50, 0x00, 0xEF);
+
 	return 0;
 }
 
diff --git a/drivers/staging/fbtft/fbtft-core.c b/drivers/staging/fbtft/fbtft-core.c
old mode 100644
new mode 100755
index 6d0363d..7fbf92e
--- a/drivers/staging/fbtft/fbtft-core.c
+++ b/drivers/staging/fbtft/fbtft-core.c
@@ -391,9 +391,15 @@ static void fbtft_update_display(struct fbtft_par *par, unsigned int start_line,
 	fbtft_par_dbg(DEBUG_UPDATE_DISPLAY, par, "%s(start_line=%u, end_line=%u)\n",
 		      __func__, start_line, end_line);
 
-	if (par->fbtftops.set_addr_win)
+	// Carefull removing this. this will work only if the full screen is updated all at once
+	if (par->fbtftops.set_addr_win){
 		par->fbtftops.set_addr_win(par, 0, start_line,
 				par->info->var.xres - 1, end_line);
+	}
+	/*if (par->fbtftops.set_addr_win){
+		par->fbtftops.set_addr_win(par, 80, start_line,
+				320 - 1, end_line);
+	}*/
 
 	offset = start_line * par->info->fix.line_length;
 	len = (end_line - start_line + 1) * par->info->fix.line_length;
-- 
1.9.1

